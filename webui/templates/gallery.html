<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SD Image Gallery</title>
    <link rel="icon" href="/static/placeholder.png" type="image/png">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="/static/gallery.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 1rem; background: #fff; border-radius: 8px; }
        .search-bar { margin-bottom: 1.5rem; }
        .gallery { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; }
        .thumb { cursor: pointer; border: none; background: none; overflow: hidden; margin: 0; }
        .thumb img { height: 150px; width: auto; display: block; }
        .thumb .meta { display: none; }
        .modal { display:none; position:fixed; z-index:1000; inset:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); overflow-y:auto; padding:2vh 0; box-sizing:border-box; align-items:flex-start; justify-content:center; }
    .modal-content { background:#fff; padding:0.9em 1em 0.9em 1em; border-radius:10px; max-width:96vw; width:96vw; display:grid; grid-template-columns:minmax(520px, 1fr) minmax(360px, 40%); gap:0.9rem; box-shadow:0 8px 32px rgba(0,0,0,0.4); position:relative; box-sizing:border-box; }
    @media (max-height:780px){ .modal-content { grid-template-columns:minmax(420px, 58%) minmax(320px, 42%); } }
    .modal-img-wrapper { display:flex; flex-direction:column; align-items:center; justify-content:flex-start; overflow:hidden; gap:0.4rem; }
    .modal img { width:100%; height:auto; max-height:calc(100vh - 22vh); object-fit:contain; border-radius:4px; background:#111; }
    #modal-path-bar { width:100%; font-family:Consolas,monospace; font-size:0.72rem; background:#222; color:#eee; padding:0.35rem 0.5rem; border-radius:4px; box-sizing:border-box; display:flex; align-items:center; gap:0.5rem; }
    #modal-path-text { flex:1 1 auto; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    #modal-path-bar button { background:#444; color:#fff; border:none; border-radius:3px; padding:0.25rem 0.55rem; font-size:0.65rem; cursor:pointer; }
    #modal-path-bar button:hover { background:#555; }
    #modal-meta-panel { display:flex; flex-direction:column; min-height:0; max-height:calc(100vh - 16vh); }
    .meta-toolbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.45em; }
    .meta-toolbar button { background:#0078d4; color:#fff; border:none; border-radius:4px; padding:0.3em 0.7em; cursor:pointer; font-size:0.72rem; }
    #modal-meta { flex:1 1 auto; width:100%; overflow:auto; white-space:pre-wrap; background:#f8f8f8; padding:0.6em 0.75em 0.85em 0.75em; border-radius:4px; font-size:0.8rem; line-height:1.26; box-sizing:border-box; word-break:break-word; max-height:100%; }
    .meta-collapsed #modal-meta-panel { display:none; }
    .meta-collapsed .modal-content { grid-template-columns:1fr; }
    @media (max-width: 1100px) { .modal-content { grid-template-columns:minmax(420px, 58%) minmax(300px, 42%); } }
    @media (max-width: 900px) { .modal-content { grid-template-columns:1fr; max-width:98vw; width:98vw; } #modal-meta-panel { order:2; max-height:calc(50vh); } .modal img { max-height:55vh; } }
        .close { float: right; font-size: 1.5em; cursor: pointer; }
    /* Removed obsolete duplicate #modal-meta rule */
    </style>
</head>
<body>
<div class="container">
    <h1>SD Image Gallery</h1>
    <form class="search-bar" id="search-form" onsubmit="return false;">
        <input type="text" id="search-input" name="search" value="{{ search }}" placeholder="Search metadata..." style="width: 300px; padding: 0.5em;">
    <button type="submit" onclick="applySearch()" aria-label="Execute search">Search</button>
    <button type="button" id="add-field-btn" onclick="addField()" aria-label="Add search field">+</button>
        <span style="margin-left:1rem;">
            <label for="sort-select" style="font-size:0.85rem;">Sort:</label>
            <select id="sort-select" onchange="applySortChange()" style="padding:0.25rem;">
                <option value="last_scanned" {% if sort=='last_scanned' %}selected{% endif %}>Last Scanned</option>
                <option value="file_name" {% if sort=='file_name' %}selected{% endif %}>File Name</option>
                <option value="file_size" {% if sort=='file_size' %}selected{% endif %}>File Size</option>
                <option value="file_mtime" {% if sort=='file_mtime' %}selected{% endif %}>Modified Time</option>
                <option value="file_ctime" {% if sort=='file_ctime' %}selected{% endif %}>Created Time</option>
                <option value="width" {% if sort=='width' %}selected{% endif %}>Width</option>
                <option value="height" {% if sort=='height' %}selected{% endif %}>Height</option>
                <option value="id" {% if sort=='id' %}selected{% endif %}>ID</option>
            </select>
            <button type="button" id="order-toggle" onclick="toggleOrder()" style="padding:0.25rem 0.5rem;">{{ 'DESC' if order=='desc' else 'ASC' }}</button>
            <span id="time-filters" style="display:inline-flex; gap:4px; margin-left:0.5rem;">
                <select id="year-select" style="padding:0.25rem; display:none;" onchange="applyTimeFilter()">
                    <option value="">Year: ALL</option>
                </select>
                <select id="month-select" style="padding:0.25rem; display:none;" onchange="applyTimeFilter()">
                    <option value="">Month: ALL</option>
                </select>
            </span>
        </span>
        <label style="margin-left: 1rem; font-weight: normal; cursor: pointer; user-select: none;">
            <input type="checkbox" id="toggle-selection-mode" style="vertical-align: middle; margin-right: 0.3em;">
            Enable Selection Mode
        </label>
        <div id="fields-container">
            {% for i in range(logics|length) %}
            <div class="search-field" data-field="{{ fields[i] }}">
                <select class="logic-select" onchange="updateSearch()">
                    <option value="AND" {% if logics[i] == 'AND' %}selected{% endif %}>AND</option>
                    <option value="OR" {% if logics[i] == 'OR' %}selected{% endif %}>OR</option>
                    <option value="NOT" {% if logics[i] == 'NOT' %}selected{% endif %}>NOT</option>
                </select>
                <input type="text" class="field-input" oninput="updateSearch()" placeholder="Enter search text" value="{{ values[i] }}">
                <button type="button" onclick="removeField(this)">-</button>
            </div>
            {% endfor %}
        </div>
    </form>

    <div class="pagination" style="margin-bottom: 1rem; text-align: center;">
        {% set total_pages = (total // page_size) + (1 if total % page_size > 0 else 0) %}
    <button
            id="prev-page-btn"
            data-target-page="{{ page - 1 if page > 1 else 1 }}"
            {% if page <= 1 %}disabled{% endif %}
            style="margin-right: 0.5rem;"
        >Previous</button>
        <span>Page {{ page }} of {{ total_pages }} ({{ total }} images)</span>
        <button
            id="next-page-btn"
            data-target-page="{{ page + 1 if page < total_pages else total_pages }}"
            {% if page >= total_pages %}disabled{% endif %}
            style="margin-left: 0.5rem;"
        >Next</button>
        <input
            type="number"
            min="1"
            max="{{ total_pages }}"
            value="{{ page }}"
            onchange="jumpToPage(this.value)"
            style="width: 4rem; margin-left: 1rem;"
        />
    </div>

    <!-- File Operations Toolbar -->
    <div id="file-ops-toolbar" style="display: none;">
        <label class="select-all-label">
            <input type="checkbox" id="select-all-checkbox" /> Select All
        </label>
        <span class="ops-count" id="selected-count">0 selected</span>
        <button id="move-btn" disabled>Move</button>
        <button id="copy-btn" disabled>Copy</button>
        <button id="delete-btn" disabled>Delete</button>
        <button id="clear-selection-btn" type="button">Clear Selection</button>
    </div>

    <div class="gallery" style="margin-top: 1rem;">
        {% include 'gallery_items.html' %}
    </div>
    <!-- Bottom Pagination / Jump Links -->
    {% set total_pages = (total // page_size) + (1 if total % page_size > 0 else 0) %}
    {% if total_pages > 1 %}
    <nav class="pagination" aria-label="Gallery pages" style="margin:2rem 0 0.5rem; text-align:center; display:flex; flex-wrap:wrap; gap:0.4rem; justify-content:center;">
        {% set window = 2 %}
        {% set ns = namespace(last=0) %}
        <style>
            .page-link{ text-decoration:none; border:1px solid #ccc; padding:0.34rem 0.62rem; border-radius:4px; min-width:34px; display:inline-block; color:#0078d4; font-size:0.85rem; }
            .page-link:hover{ background:#eef6ff; }
            .page-link.current{ background:#0078d4; color:#fff; border-color:#0078d4; cursor:default; }
        </style>
        {% for p in range(1, total_pages + 1) %}
            {% if p <= 2 or p > total_pages - 2 or (p >= page - window and p <= page + window) %}
                {% if ns.last + 1 < p %}
                    <span style="padding:0 0.4rem; color:#666;">â€¦</span>
                {% endif %}
                {% if p == page %}
                    <span aria-current="page" class="page-link current">{{ p }}</span>
                {% else %}
                    <a href="#page-{{ p }}" data-page="{{ p }}" class="page-link">{{ p }}</a>
                {% endif %}
                {% set ns.last = p %}
            {% endif %}
        {% endfor %}
    </nav>
    {% endif %}
</div>
</div>
<div class="modal" id="modal">
    <div class="modal-content" id="modal-inner">
    <button class="close" onclick="hideModal()" aria-label="Close modal" style="background:rgba(0,0,0,0.55);color:#fff;border:none;position:absolute;top:6px;right:6px;font-size:1.4rem;line-height:1;width:34px;height:34px;border-radius:6px;display:flex;align-items:center;justify-content:center;">&times;</button>
    <div class="modal-img-wrapper" id="modal-img-wrapper">
        <img id="modal-img" src="" alt="Image">
        <div id="modal-path-bar" title="Full file path">
            <span id="modal-path-text"></span>
            <button type="button" onclick="copyImagePath()" aria-label="Copy image path">Copy Path</button>
        </div>
    </div>
    <div id="modal-meta-panel">
            <div class="meta-toolbar">
                <strong style="font-size:0.85rem">Metadata</strong>
                <div style="display:flex;gap:4px;">
                    <button type="button" onclick="copyMetadata()" aria-label="Copy metadata JSON">Copy</button>
                    <button type="button" onclick="toggleMetadata()" aria-label="Toggle metadata panel" id="toggle-meta-btn">Hide</button>
                </div>
            </div>
            <pre id="modal-meta"></pre>
        </div>
    </div>
</div>
<script>
let availableFields = [];
let fieldsLoaded = false;
// --- Global selection state (was previously function-scoped causing bugs) ---
let selectedIds = new Set();            // Explicitly checked IDs (current page when not global select)
let globalQuerySelectAll = false;       // Flag: user chose Select All (query-wide)
let globalMatchTotal = null;            // Total matches for current query (fetched async)
let excludedIds = new Set();            // IDs explicitly unchecked after Select All

async function fetchFields() {
    if (fieldsLoaded) return;
    try {
        const response = await fetch('/metadata_fields');
        if (!response.ok) {
            console.error('Failed to fetch metadata fields:', response.statusText);
            return;
        }
        availableFields = await response.json();
        fieldsLoaded = true;
        const addFieldBtn = document.getElementById('add-field-btn');
        if (addFieldBtn) {
            addFieldBtn.disabled = false;
        } else {
            console.error('Add Field button not found');
        }
    } catch (error) {
        console.error('Error fetching metadata fields:', error);
    }
}

function addField() {
    const container = document.getElementById('fields-container');
    const div = document.createElement('div');
    div.className = 'search-field';

    const logicSelect = document.createElement('select');
    logicSelect.className = 'logic-select';
    logicSelect.onchange = updateSearch;
    ['AND', 'OR', 'NOT'].forEach(logic => {
        const option = document.createElement('option');
        option.value = logic;
        option.textContent = logic;
        logicSelect.appendChild(option);
    });

    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'field-input';
    input.placeholder = 'Enter search text';
    input.oninput = updateSearch;

    const button = document.createElement('button');
    button.type = 'button';
    button.textContent = '-';
    button.onclick = () => {
        div.remove();
        updateSearch();
    };

    div.appendChild(logicSelect);
    div.appendChild(input);
    div.appendChild(button);
    container.appendChild(div);
}

function removeField(button) {
    button.parentElement.remove();
    updateSearch();
}

function updateSearch() {
    // Optionally, implement live search or validation here
}

function applySearch() {
    const searchInput = document.getElementById('search-input');
    const fieldsContainer = document.getElementById('fields-container');
    const logics = [];
    const values = [];
    const sortSel = document.getElementById('sort-select');
    const orderBtn = document.getElementById('order-toggle');
    const currentSort = sortSel ? sortSel.value : 'last_scanned';
    const currentOrder = orderBtn ? orderBtn.textContent.trim().toLowerCase() : 'desc';

    fieldsContainer.querySelectorAll('.search-field').forEach(div => {
        const logicSelect = div.querySelector('.logic-select');
        const input = div.querySelector('.field-input');
        if (input.value.trim() !== '') {
            logics.push(logicSelect.value);
            values.push(input.value.trim());
        }
    });

    let url = '/?';
    if (searchInput.value.trim() !== '') {
        url += "search=" + encodeURIComponent(searchInput.value.trim()) + "&";
    }
    logics.forEach((logic, i) => {
        url += "logics=" + encodeURIComponent(logic) + "&";
    });
    values.forEach((value, i) => {
        url += "values=" + encodeURIComponent(value) + "&";
    });
    // Remove trailing &
    if (url.endsWith("&")) {
        url = url.slice(0, -1);
    }

    // Append current page=1 when applying new search
    url += "&page=1";
    url += "&sort=" + encodeURIComponent(currentSort) + "&order=" + encodeURIComponent(currentOrder);
    const ySel = document.getElementById('year-select');
    const mSel = document.getElementById('month-select');
    if(ySel && ySel.style.display!== 'none' && ySel.value){ url += '&year=' + encodeURIComponent(ySel.value); }
    if(mSel && mSel.style.display!== 'none' && mSel.value){ url += '&month=' + encodeURIComponent(mSel.value); }

    window.location.href = url;
}

function goToPage(page) {
    const urlParams = new URLSearchParams(window.location.search);
    const search = urlParams.get('search') || '';
    const logics = urlParams.getAll('logics');
    const values = urlParams.getAll('values');
    const pageSize = urlParams.get('page_size') || 100;
    const sort = urlParams.get('sort') || document.getElementById('sort-select')?.value || 'last_scanned';
    const order = urlParams.get('order') || document.getElementById('order-toggle')?.textContent.trim().toLowerCase() || 'desc';
    const year = urlParams.get('year') || '';
    const month = urlParams.get('month') || '';

    let url = '/?';
    if (search.trim() !== '') {
        url += "search=" + encodeURIComponent(search) + "&";
    }
    logics.forEach(logic => {
        url += "logics=" + encodeURIComponent(logic) + "&";
    });
    values.forEach(value => {
        url += "values=" + encodeURIComponent(value) + "&";
    });
    url += "page=" + page + "&page_size=" + pageSize + "&sort=" + encodeURIComponent(sort) + "&order=" + encodeURIComponent(order);
    if(year) url += '&year=' + encodeURIComponent(year);
    if(month) url += '&month=' + encodeURIComponent(month);

    window.location.href = url;
}

function jumpToPage(value) {
    let page = parseInt(value);
    if (isNaN(page) || page < 1) {
        page = 1;
    }
    goToPage(page);
}

function showModal(el) {
    const imgPath = el.getAttribute('data-file-path');
    const id = el.getAttribute('data-id');
    const hash = el.getAttribute('data-hash');
    const modal = document.getElementById('modal');
    const metaPre = document.getElementById('modal-meta');
    // Optimistic placeholder while fetching metadata
    if (metaPre) metaPre.textContent = 'Loading metadata...';
    document.getElementById('modal-img').src = "/image/" + id + (hash ? ("?v=" + hash) : "");
    modal.style.display = 'flex';
    const pathEl = document.getElementById('modal-path-text');
    if(pathEl){ pathEl.textContent = imgPath || ''; pathEl.parentElement.title = imgPath || ''; }
    modal.classList.remove('meta-collapsed');
    const toggleBtn = document.getElementById('toggle-meta-btn');
    if (toggleBtn) toggleBtn.textContent = 'Hide';
    // Lazy fetch metadata
    fetch('/metadata/' + id)
        .then(r => r.ok ? r.json() : Promise.reject('Failed to fetch metadata'))
        .then(data => {
            let mj = data.metadata_json || ''; let formatted = mj;
            try { if(mj){ formatted = JSON.stringify(JSON.parse(mj), null, 2); } } catch(e){}
            if (metaPre) metaPre.textContent = formatted;
        })
        .catch(err => { if(metaPre) metaPre.textContent = 'Error loading metadata'; console.error(err); });
}

function hideModal() {
    document.getElementById('modal').style.display = "none";
}

window.onclick = function(event) {
    var modal = document.getElementById('modal');
    if (event.target == modal) {
        hideModal();
    }
}

window.onload = () => {
    fetchFields();
    setupGallerySelection();
    setupSelectionModeToggle();
    const prevBtn = document.getElementById('prev-page-btn');
    if(prevBtn){ prevBtn.addEventListener('click', ()=>{ const p = parseInt(prevBtn.getAttribute('data-target-page')); if(!isNaN(p)) goToPage(p); }); }
    const nextBtn = document.getElementById('next-page-btn');
    if(nextBtn){ nextBtn.addEventListener('click', ()=>{ const p = parseInt(nextBtn.getAttribute('data-target-page')); if(!isNaN(p)) goToPage(p); }); }
    // Reflect order button text from URL params if present
    const urlParams = new URLSearchParams(window.location.search);
    const orderParam = urlParams.get('order');
    if(orderParam){ const ob = document.getElementById('order-toggle'); if(ob){ ob.textContent = orderParam.toUpperCase()==='ASC'?'ASC':'DESC'; } }
    initTimeFacetControls();
    document.addEventListener('click', e => {
        const link = e.target.closest('a.page-link[data-page]');
        if(link){
            e.preventDefault();
            const p = parseInt(link.getAttribute('data-page'));
            if(!isNaN(p)) goToPage(p);
        }
    });
};

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        hideModal();
    }
});

function toggleMetadata() {
    const modal = document.getElementById('modal');
    modal.classList.toggle('meta-collapsed');
    const btn = document.getElementById('toggle-meta-btn');
    if (btn) {
        btn.textContent = modal.classList.contains('meta-collapsed') ? 'Show' : 'Hide';
    }
}

function copyMetadata() {
    const pre = document.getElementById('modal-meta');
    if (!pre) return;
    const text = pre.textContent || '';
    navigator.clipboard.writeText(text).then(()=>{
        const btn = document.querySelector('button[onclick="copyMetadata()"]');
        if (btn) {
            const old = btn.textContent;
            btn.textContent = 'Copied';
            setTimeout(()=> btn.textContent = old, 1200);
        }
    }).catch(()=>{});
}

function copyImagePath(){
    const el = document.getElementById('modal-path-text');
    if(!el) return;
    const path = el.textContent || '';
    if(!path) return;
    navigator.clipboard.writeText(path).then(()=>{
        const btn = el.parentElement.querySelector('button');
        if(btn){ const old=btn.textContent; btn.textContent='Copied'; setTimeout(()=>btn.textContent=old,1100); }
    }).catch(()=>{});
}

// Removed dynamic resize & auto-balance logic for simplified consistent layout.

/* --- File Operations Selection Logic --- */
function setupGallerySelection() {
    const gallery = document.querySelector('.gallery');
    if (!gallery) return;

    const toolbar = document.getElementById('file-ops-toolbar');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const selectedCountSpan = document.getElementById('selected-count');
    const moveBtn = document.getElementById('move-btn');
    const copyBtn = document.getElementById('copy-btn');
    const deleteBtn = document.getElementById('delete-btn');
    const clearBtn = document.getElementById('clear-selection-btn');

    function updateToolbar() {
    // When in globalQuerySelectAll mode we conceptually select all matching DB rows
    // minus any IDs the user explicitly unchecked (excludedIds). selectedIds contains
    // only the currently visible (page) checked boxes, so we derive count from
    // globalMatchTotal - excludedIds to avoid capping at current page size.
        let count;
        if (globalQuerySelectAll) {
            // Show total matching minus exclusions if we know it
            if (globalMatchTotal !== null) {
                count = Math.max(0, globalMatchTotal - excludedIds.size);
            } else {
                count = selectedIds.size; // fallback until fetched
            }
            selectedCountSpan.textContent = count + " selected (all matching)";
        } else {
            count = selectedIds.size;
            selectedCountSpan.textContent = count + " selected";
        }
        moveBtn.disabled = copyBtn.disabled = deleteBtn.disabled = (count === 0);
        toolbar.style.display = (count > 0) ? "flex" : "none";
    }

    function setSelectionMode(on) {
        gallery.querySelectorAll('.thumb').forEach(thumb => {
            const label = thumb.querySelector('.thumb-checkbox-label');
            if (on) {
                thumb.classList.add('selection-mode');
                if (label) label.style.display = "block";
            } else {
                thumb.classList.remove('selection-mode');
                if (label) label.style.display = "none";
                // Uncheck all checkboxes and clear selection when disabling
                const cb = thumb.querySelector('.thumb-checkbox');
                if (cb) cb.checked = false;
            }
        });
        if (!on) {
            selectedIds.clear();
            updateToolbar();
        }
    }

    // Show checkbox on hover only if selection mode is enabled
    gallery.addEventListener('mouseover', e => {
        const thumb = e.target.closest('.thumb');
        if (thumb && thumb.classList.contains('selection-mode')) {
            const label = thumb.querySelector('.thumb-checkbox-label');
            if (label) label.style.display = "block";
        }
    });
    gallery.addEventListener('mouseout', e => {
        const thumb = e.target.closest('.thumb');
        if (thumb && thumb.classList.contains('selection-mode')) {
            const label = thumb.querySelector('.thumb-checkbox-label');
            if (label) label.style.display = "block";
        }
    });

    // Checkbox click logic
    gallery.addEventListener('change', e => {
        if (e.target.classList.contains('thumb-checkbox')) {
            const id = e.target.getAttribute('data-id');
            if (e.target.checked) {
                if (globalQuerySelectAll) {
                    // Removing from exclusions if previously excluded
                    excludedIds.delete(id);
                }
                selectedIds.add(id);
            } else {
                selectedIds.delete(id);
                if (globalQuerySelectAll) {
                    // Track explicit exclusion when in global select mode
                    excludedIds.add(id);
                }
            }
            setSelectionMode(selectedIds.size > 0 || globalQuerySelectAll);
            updateToolbar();
        }
    });

    // Select All logic
    // (state now global â€“ removed local declarations)
    selectAllCheckbox.addEventListener('change', async e => {
        const allCheckboxes = gallery.querySelectorAll('.thumb-checkbox');
        if (e.target.checked) {
            globalQuerySelectAll = true;
            excludedIds.clear();
            // Mark current page items checked visually
            allCheckboxes.forEach(cb => { cb.checked = true; selectedIds.add(cb.getAttribute('data-id')); });
            setSelectionMode(true);
            // Fetch total matching count for display
            fetchMatchingCount().then(()=> updateToolbar()).catch(()=> updateToolbar());
        } else {
            globalQuerySelectAll = false;
            excludedIds.clear();
            allCheckboxes.forEach(cb => { cb.checked = false; });
            selectedIds.clear();
            setSelectionMode(false);
            updateToolbar();
        }
    });

    // Clear Selection
    clearBtn.addEventListener('click', () => {
        const allCheckboxes = gallery.querySelectorAll('.thumb-checkbox');
        allCheckboxes.forEach(cb => {
            cb.checked = false;
            selectedIds.delete(cb.getAttribute('data-id'));
        });
        globalQuerySelectAll = false;
        excludedIds.clear();
        setSelectionMode(false);
        updateToolbar();
    });

    // File operation button handlers (to be implemented)
    moveBtn.addEventListener('click', () => { handleFileOperation('move'); });
    copyBtn.addEventListener('click', () => { handleFileOperation('copy'); });
    deleteBtn.addEventListener('click', () => { handleFileOperation('delete'); });

    // Initial state
    setSelectionMode(false);
    updateToolbar();
}

async function handleFileOperation(op) {
    const ids = Array.from(selectedIds).map(x=>parseInt(x,10));
    if (!globalQuerySelectAll && ids.length === 0) return;
    if (op === 'delete') {
        const scopeDesc = globalQuerySelectAll ? 'ALL matching images (this may be very large)' : `${ids.length} image(s)`;
        if (!confirm(`Are you sure you want to delete ${scopeDesc}? This cannot be undone.`)) return;
    }

    let destination = null;
    if (op === 'move' || op === 'copy') {
    destination = prompt('Enter destination folder path:');
    if(!destination){ return; }
    }

    // Determine scope
    const urlParams = new URLSearchParams(window.location.search);
    const search = urlParams.get('search') || '';
    const logics = urlParams.getAll('logics');
    const values = urlParams.getAll('values');
    let scope;
    if (globalQuerySelectAll) {
        const urlParams = new URLSearchParams(window.location.search);
        const sort = urlParams.get('sort') || 'last_scanned';
        const year = urlParams.get('year') || '';
        const month = urlParams.get('month') || '';
        scope = { type: 'query', search, logics, values, sort, year, month, excluded: Array.from(excludedIds).map(x=>parseInt(x,10)) };
    } else {
        scope = { type: 'ids', ids };
    }
    try {
        const response = await fetch('/file_operation_async', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ operation: op, scope, destination })
        });
        const data = await response.json();
        if(!response.ok){ alert('Failed to start operation: ' + (data.detail || 'Unknown error')); return; }
        const jobId = data.job_id;
        monitorJob(jobId, op);
    } catch(err){
        alert('Error starting operation: ' + err);
    }
}

async function monitorJob(jobId, op){
    const statusEl = ensureStatusBar();
    let done = false;
    while(!done){
        try {
            const r = await fetch('/file_operation_status/' + jobId);
            if(!r.ok){ statusEl.textContent = 'Job ' + jobId + ' status fetch failed.'; break; }
            const s = await r.json();
            const total = s.total || 0;
            const processed = s.processed || 0;
            const pct = total ? ((processed/total)*100).toFixed(1) : (s.status==='completed'? '100.0':'0.0');
            statusEl.textContent = `Operation ${op} - ${s.status} - ${processed}/${total||'?'} (${pct}%) errors:${s.error_count}`;
            if(s.status === 'completed' || s.status === 'failed'){ done = true; break; }
        } catch(e){ statusEl.textContent = 'Monitoring error: ' + e; break; }
        await new Promise(res=>setTimeout(res, 1200));
    }
    // Fetch final details to show sample errors if nothing processed
    try {
        const rFinal = await fetch('/file_operation_status/' + jobId);
        if(rFinal.ok){
            const sFinal = await rFinal.json();
            if((sFinal.processed||0) === 0 && (sFinal.error_count||0) > 0){
                const sample = (sFinal.errors||[]).slice(0,3).join(' | ');
                statusEl.textContent += ' (sample errors: ' + sample + ')';
            }
        }
    } catch(_){}
    setTimeout(()=>window.location.reload(), 1400);
}

function ensureStatusBar(){
    let bar = document.getElementById('op-status-bar');
    if(!bar){
        bar = document.createElement('div');
        bar.id = 'op-status-bar';
        bar.style.cssText = 'position:fixed;bottom:8px;left:8px;background:#222;color:#eee;padding:6px 10px;border-radius:4px;font-size:12px;z-index:1500;';
        document.body.appendChild(bar);
    }
    return bar;
}

async function fetchMatchingCount(){
    globalMatchTotal = null;
    const urlParams = new URLSearchParams(window.location.search);
    const search = urlParams.get('search') || '';
    const logics = urlParams.getAll('logics');
    const values = urlParams.getAll('values');
    const order = urlParams.get('order') || 'desc';
    const sort = urlParams.get('sort') || 'last_scanned';
    const year = urlParams.get('year') || '';
    const month = urlParams.get('month') || '';
    let query = '/matching_count?';
    if (search.trim() !== '') query += 'search=' + encodeURIComponent(search) + '&';
    logics.forEach(l=> query += 'logics=' + encodeURIComponent(l) + '&');
    values.forEach(v=> query += 'values=' + encodeURIComponent(v) + '&');
    // Include time facet inputs & sort so total reflects same filter
    if(sort) query += '&sort=' + encodeURIComponent(sort);
    if(year) query += '&year=' + encodeURIComponent(year);
    if(month) query += '&month=' + encodeURIComponent(month);
    if(query.endsWith('&')) query = query.slice(0,-1);
    const r = await fetch(query);
    if(!r.ok) return;
    const data = await r.json();
    if(typeof data.total === 'number') globalMatchTotal = data.total;
}
function applySortChange(){
    // Reset to page 1 preserving existing search parameters
    const urlParams = new URLSearchParams(window.location.search);
    const search = urlParams.get('search') || '';
    const logics = urlParams.getAll('logics');
    const values = urlParams.getAll('values');
    const pageSize = urlParams.get('page_size') || 100;
    const sortSel = document.getElementById('sort-select');
    const orderBtn = document.getElementById('order-toggle');
    const sort = sortSel ? sortSel.value : 'last_scanned';
    const order = orderBtn ? orderBtn.textContent.trim().toLowerCase() : 'desc';
    const ySel = document.getElementById('year-select');
    const mSel = document.getElementById('month-select');
    let selectedYear = ySel && ySel.style.display !== 'none' ? ySel.value : '';
    let selectedMonth = mSel && mSel.style.display !== 'none' ? mSel.value : '';
    // If switching to non time-based sort, discard year/month
    if(sort !== 'file_mtime' && sort !== 'file_ctime'){
        selectedYear=''; selectedMonth='';
    }
    let url='/?';
    if(search.trim()!=='') url += 'search=' + encodeURIComponent(search) + '&';
    logics.forEach(l=> url+='logics='+encodeURIComponent(l)+'&');
    values.forEach(v=> url+='values='+encodeURIComponent(v)+'&');
    url += 'page=1&page_size=' + pageSize + '&sort=' + encodeURIComponent(sort) + '&order=' + encodeURIComponent(order);
    if(selectedYear) url += '&year=' + encodeURIComponent(selectedYear);
    if(selectedMonth) url += '&month=' + encodeURIComponent(selectedMonth);
    window.location.href = url;
}
function toggleOrder(){
    const btn = document.getElementById('order-toggle');
    if(!btn) return;
    btn.textContent = btn.textContent.trim().toUpperCase()==='DESC' ? 'ASC' : 'DESC';
    applySortChange();
}
async function initTimeFacetControls(){
    const sortSel = document.getElementById('sort-select');
    const yearSel = document.getElementById('year-select');
    const monthSel = document.getElementById('month-select');
    if(!sortSel || !yearSel || !monthSel) return;
    const urlParams = new URLSearchParams(window.location.search);
    const currentSort = sortSel.value;
    const currentYear = urlParams.get('year') || '';
    const currentMonth = urlParams.get('month') || '';
    if(currentSort === 'file_mtime' || currentSort === 'file_ctime'){
        // Show year select and populate
        await populateYearMonth(currentSort, currentYear, currentMonth);
    } else {
        yearSel.style.display='none';
        monthSel.style.display='none';
    }
    sortSel.addEventListener('change', ()=>{
        const v = sortSel.value;
        if(v==='file_mtime' || v==='file_ctime'){
            populateYearMonth(v, '', '');
        } else {
            yearSel.style.display='none';
            monthSel.style.display='none';
        }
    });
    yearSel.addEventListener('change', ()=>{
        const vYear = yearSel.value;
        const vSort = sortSel.value;
        if(vYear){ populateMonthsOnly(vSort, vYear, monthSel.value); }
    });
}
async function populateYearMonth(sortKey, selectedYear, selectedMonth){
    const yearSel = document.getElementById('year-select');
    const monthSel = document.getElementById('month-select');
    if(!yearSel || !monthSel) return;
    yearSel.innerHTML = '<option value="">Year: ALL</option>';
    monthSel.innerHTML = '<option value="">Month: ALL</option>';
    try{
        const r = await fetch('/time_facets?column=' + encodeURIComponent(sortKey));
        if(!r.ok) throw new Error('facet fetch failed');
        const data = await r.json();
        (data.years||[]).forEach(y=>{
            const opt = document.createElement('option'); opt.value=y; opt.textContent=y; if(selectedYear===y) opt.selected=true; yearSel.appendChild(opt);
        });
        yearSel.style.display='inline-block';
        // If a year selected, fetch months
        if(selectedYear){ await populateMonthsOnly(sortKey, selectedYear, selectedMonth); }
        else { monthSel.style.display='none'; }
    }catch(e){ yearSel.style.display='none'; monthSel.style.display='none'; }
}
async function populateMonthsOnly(sortKey, year, selectedMonth){
    const monthSel = document.getElementById('month-select');
    if(!monthSel){ return; }
    monthSel.innerHTML = '<option value="">Month: ALL</option>';
    if(!year){ monthSel.style.display='none'; return; }
    try{
        const r = await fetch('/time_facets?column=' + encodeURIComponent(sortKey) + '&year=' + encodeURIComponent(year));
        if(!r.ok) throw new Error('months fetch failed');
        const data = await r.json();
        (data.months||[]).forEach(m=>{ const opt=document.createElement('option'); opt.value=m; opt.textContent=m; if(selectedMonth===m) opt.selected=true; monthSel.appendChild(opt); });
        monthSel.style.display='inline-block';
    }catch(e){ monthSel.style.display='none'; }
}
function applyTimeFilter(){
    applySortChange();
}
function setupSelectionModeToggle() {
    const selectionModeCheckbox = document.getElementById('toggle-selection-mode');
    const gallery = document.querySelector('.gallery');
    if (!selectionModeCheckbox || !gallery) return;

    selectionModeCheckbox.addEventListener('change', function() {
        if (this.checked) {
            gallery.querySelectorAll('.thumb').forEach(thumb => {
                thumb.classList.add('selection-mode');
                const label = thumb.querySelector('.thumb-checkbox-label');
                if (label) label.style.display = "block";
            });
        } else {
            gallery.querySelectorAll('.thumb').forEach(thumb => {
                thumb.classList.remove('selection-mode');
                const label = thumb.querySelector('.thumb-checkbox-label');
                if (label) label.style.display = "none";
                // Uncheck all checkboxes
                const cb = thumb.querySelector('.thumb-checkbox');
                if (cb) cb.checked = false;
            });
            // Hide toolbar and clear selection
            const toolbar = document.getElementById('file-ops-toolbar');
            if (toolbar) toolbar.style.display = "none";
            const selectedCountSpan = document.getElementById('selected-count');
            if (selectedCountSpan) selectedCountSpan.textContent = "0 selected";
        }
    });

    // Set initial state
    if (selectionModeCheckbox.checked) {
        gallery.querySelectorAll('.thumb').forEach(thumb => {
            thumb.classList.add('selection-mode');
            const label = thumb.querySelector('.thumb-checkbox-label');
            if (label) label.style.display = "block";
        });
    } else {
        gallery.querySelectorAll('.thumb').forEach(thumb => {
            thumb.classList.remove('selection-mode');
            const label = thumb.querySelector('.thumb-checkbox-label');
            if (label) label.style.display = "none";
        });
    }
}
</script>
</body>
</html>
